# AO CLI TraceåŠŸèƒ½è°ƒè¯•åˆ†ææŠ¥å‘Š

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº†å¯¹AO CLI `eval --trace` åŠŸèƒ½è¿›è¡Œæ·±å…¥è°ƒè¯•å’Œåˆ†æçš„å…¨è¿‡ç¨‹ã€‚é€šè¿‡ç³»ç»Ÿæ€§çš„è°ƒè¯•ï¼Œå‘ç°äº†CU APIæ•°æ®è®°å½•æœºåˆ¶çš„å…³é”®ç‰¹æ€§ï¼Œä»¥åŠTraceåŠŸèƒ½è®¾è®¡ä¸­çš„æ ¸å¿ƒé—®é¢˜ã€‚

## èƒŒæ™¯

### é—®é¢˜æè¿°

åœ¨æµ‹è¯•AO CLIçš„`eval --trace`åŠŸèƒ½æ—¶ï¼Œå‘ç°äº†ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡ï¼š

- **æœ‰äº›è¿›ç¨‹**ï¼šTraceåŠŸèƒ½èƒ½æˆåŠŸæ‰¾åˆ°å¹¶æ˜¾ç¤ºæ¥æ”¶è¿›ç¨‹Handlerçš„printè¾“å‡º
- **æœ‰äº›è¿›ç¨‹**ï¼šTraceåŠŸèƒ½åªèƒ½æ‰¾åˆ°"Message added to outbox"çš„ç³»ç»Ÿè¾“å‡ºï¼Œæ— æ³•è·å–çœŸæ­£çš„Handlerè¾“å‡º

è¿™å¼•å‘äº†å…³äºAOè¿›ç¨‹éš”ç¦»æœºåˆ¶å’ŒCU APIæ•°æ®è®°å½•çš„æ·±å…¥æ€è€ƒã€‚

### åˆå§‹å‡è®¾

æœ€åˆæˆ‘ä»¬è®¤ä¸ºï¼š
1. AOè¿›ç¨‹ä¸¥æ ¼éš”ç¦»ï¼ŒCU APIä¸ä¼šè®°å½•è·¨è¿›ç¨‹çš„Handlerè¾“å‡º
2. TraceåŠŸèƒ½çš„è®¾è®¡å­˜åœ¨ç¼ºé™·
3. CU APIåœ¨legacy/testnetæ¨¡å¼ä¸‹æ•°æ®è®°å½•ä¸å®Œæ•´

## è°ƒè¯•è¿‡ç¨‹

### Phase 1: è¡¨è±¡åˆ†æ

#### æµ‹è¯•ç¯å¢ƒè®¾ç½®

```bash
# è®¾ç½®ä»£ç†ç¯å¢ƒ
export HTTPS_PROXY=http://127.0.0.1:1235 HTTP_PROXY=http://127.0.0.1:1235 ALL_PROXY=socks5://127.0.0.1:1235

# è¿è¡Œæµ‹è¯•è„šæœ¬
./tests/cross-process-print-test.sh
```

#### ç°è±¡è§‚å¯Ÿ

**æˆåŠŸçš„æµ‹è¯•è¾“å‡º**ï¼š
```
ğŸ“¤ è¿½è¸ªæ¶ˆæ¯ 1/1:
   ğŸ¯ ç›®æ ‡è¿›ç¨‹: TRfiL50sGVkhPVNdkYK8aVmCekMtLruCNZVXOOf1L5s
   ğŸ”— æ¶ˆæ¯Reference: 2
   ğŸ”„ æŸ¥è¯¢ç›®æ ‡è¿›ç¨‹ç»“æœå†å²ï¼Œå°è¯•é€šè¿‡Reference=2å…³è”å¤„ç†ç»“æœ (æœ€å¤šå°è¯• 12 æ¬¡)...
   âœ… ç¬¬1æ¬¡å°è¯•æˆåŠŸï¼æ‰¾åˆ°Reference=2çš„Handlerå¤„ç†ç»“æœ
   ğŸ“ å‘ç°Handlerä¸­çš„printè¾“å‡º:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ğŸ¯ æ¥æ”¶è¿›ç¨‹Handlerå¼€å§‹æ‰§è¡Œ
   â”‚ ğŸ“¨ æ”¶åˆ°æ¥è‡ªå‘é€è¿›ç¨‹çš„æ¶ˆæ¯: Traceæµ‹è¯•æ¶ˆæ¯
   â”‚ ğŸ”„ å¤„ç†ä¸­...
   â”‚ ğŸ“¤ å‘é€å“åº”æ¶ˆæ¯
   â”‚ âœ… æ¥æ”¶è¿›ç¨‹Handleræ‰§è¡Œå®Œæˆ
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¤±è´¥çš„æµ‹è¯•è¾“å‡º**ï¼š
```
ğŸ“¤ è¿½è¸ªæ¶ˆæ¯ 1/1:
   ğŸ¯ ç›®æ ‡è¿›ç¨‹: G8XryOcdv-AcyPMJa7wQ1IHbEvfmhGEDENnI6qe8U_U
   ğŸ”— æ¶ˆæ¯Reference: 8
   ğŸ”„ æŸ¥è¯¢ç›®æ ‡è¿›ç¨‹ç»“æœå†å²ï¼Œå°è¯•é€šè¿‡Reference=8å…³è”å¤„ç†ç»“æœ (æœ€å¤šå°è¯• 12 æ¬¡)...
   â³ ç¬¬1æ¬¡å°è¯•æœªæ‰¾åˆ°æ»¡æ„ç»“æœï¼Œç­‰å¾… 8000ms åé‡è¯•...
   âœ… ç»è¿‡12æ¬¡å°è¯•ï¼Œä½¿ç”¨å¤‡é€‰ç»“æœï¼šç³»ç»Ÿè¾“å‡º
   ğŸ“ å‘ç°Handlerä¸­çš„printè¾“å‡º:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ {
   â”‚    onReply = function: 0x41341a0,
   â”‚    receive = function: 0x41232a0,
   â”‚    output = "Message added to outbox"
   â”‚ }
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 2: CU APIæ•°æ®ç»“æ„åˆ†æ

#### å·¥å…·å¼€å‘

ä¸ºäº†æ·±å…¥åˆ†æCU APIè¿”å›çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ªä¸“é—¨çš„è°ƒè¯•å·¥å…· `test-cu-api-debug.js`ï¼š

```javascript
// ä¸»è¦åŠŸèƒ½ï¼š
// 1. æŸ¥è¯¢æŒ‡å®šè¿›ç¨‹çš„å†å²ç»“æœè®°å½•
// 2. è¯¦ç»†åˆ†ææ¯æ¡è®°å½•çš„æ•°æ®ç»“æ„
// 3. è¯†åˆ«æ¶ˆæ¯ç±»å‹å’Œè¾“å‡ºå†…å®¹ç‰¹å¾
// 4. æ£€æµ‹ANSIé¢œè‰²ä»£ç ç­‰æ ¼å¼é—®é¢˜
```

#### æ¦‚å¿µæ¾„æ¸…

åœ¨ç»§ç»­åˆ†æä¹‹å‰ï¼Œéœ€è¦æ¾„æ¸…å‡ ä¸ªé‡è¦æ¦‚å¿µï¼š

- **AO (Actor Oriented)**: ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œå¼ºè°ƒæ¶ˆæ¯ä¼ é€’å’Œè¿›ç¨‹éš”ç¦»
- **AOS (Arweave Operating System)**: åŸºäºArweaveçš„AOå®ç°ï¼Œæä¾›REPL shellç¯å¢ƒ
- **CU (Compute Unit)**: AOç½‘ç»œä¸­çš„è®¡ç®—èŠ‚ç‚¹ï¼Œè´Ÿè´£æ‰§è¡Œè¿›ç¨‹å’Œè®°å½•ç»“æœ
- **MU (Messenger Unit)**: AOç½‘ç»œä¸­çš„æ¶ˆæ¯èŠ‚ç‚¹ï¼Œè´Ÿè´£æ¶ˆæ¯ä¼ é€’

AOSæ˜¯AOç”Ÿæ€ç³»ç»Ÿä¸­çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼Œä¸æ˜¯AOç½‘ç»œæœ¬èº«ã€‚æœ¬åˆ†æå…³æ³¨çš„æ˜¯AOç½‘ç»œçš„åº•å±‚æœºåˆ¶ã€‚

#### æ•°æ®ç»“æ„å‘ç°

é€šè¿‡è°ƒè¯•å·¥å…·ï¼Œæˆ‘ä»¬å‘ç°äº†CU APIè¿”å›çš„æ•°æ®ç»“æ„ï¼š

```json
{
  "pageInfo": {
    "hasNextPage": true
  },
  "edges": [
    {
      "node": {
        "Messages": [
          {
            "Target": "process_id",
            "Data": "message_data",
            "Tags": [
              {"value": "3", "name": "Reference"},
              {"value": "ActionName", "name": "Action"}
            ]
          }
        ],
        "Assignments": [],
        "Spawns": [],
        "Output": {
          "data": "output_content",
          "test": "lua_table_representation",
          "prompt": "aos_prompt_with_ansi_colors"
        }
      },
      "cursor": "pagination_cursor"
    }
  ]
}
```

### Phase 3: å…³é”®å‘ç°

#### æ¶ˆæ¯å¤„ç†é“¾åˆ†æ

é€šè¿‡å¯¹å®Œæ•´å†å²è®°å½•çš„åˆ†æï¼Œæˆ‘ä»¬å‘ç°äº†æ¶ˆæ¯å¤„ç†çš„å®Œæ•´é“¾æ¡ï¼š

**æ—¶é—´çº¿åˆ†æï¼ˆä»æœ€æ–°åˆ°æœ€æ—§ï¼‰**ï¼š

| è®°å½•# | Reference | Action                   | Outputç±»å‹      | å†…å®¹ç‰¹å¾           |
| ----- | --------- | ------------------------ | --------------- | ------------------ |
| #18   | 9         | NFT-Transferable-Updated | ä¸šåŠ¡Handlerè¾“å‡º | âœ… åŒ…å«è¯¦ç»†æ“ä½œæ—¥å¿— |
| #19   | 8         | Set-NFT-Transferable     | ç³»ç»Ÿè¾“å‡º        | âŒ AOSå†…éƒ¨æ ¼å¼      |
| #24   | 7         | Mint-Confirmation        | ä¸šåŠ¡Handlerè¾“å‡º | âœ… åŒ…å«è¯¦ç»†æ“ä½œæ—¥å¿— |
| #25   | 6         | Mint-NFT                 | ç³»ç»Ÿè¾“å‡º        | âŒ AOSå†…éƒ¨æ ¼å¼      |
| #37   | 2         | Mint-Confirmation        | ä¸šåŠ¡Handlerè¾“å‡º | âœ… åŒ…å«è¯¦ç»†æ“ä½œæ—¥å¿— |
| #38   | 1         | Mint-NFT                 | ç³»ç»Ÿè¾“å‡º        | âŒ AOSå†…éƒ¨æ ¼å¼      |

#### æ¶ˆæ¯ç±»å‹åˆ†ç±»

**ç³»ç»Ÿæ¶ˆæ¯ï¼ˆSystem Messagesï¼‰**ï¼š
```json
{
  "Messages": [],
  "Output": {
    "data": "{\n   onReply = function: 0x41341a0,\n   receive = function: 0x41232a0,\n   output = \"Message added to outbox\"\n}",
    "prompt": "[Inbox:4]> "
  }
}
```

**ä¸šåŠ¡æ¶ˆæ¯ï¼ˆBusiness Messagesï¼‰**ï¼š
```json
{
  "Messages": [
    {
      "Tags": [{"name": "Reference", "value": "9"}]
    }
  ],
  "Output": {
    "data": "ğŸ¯ æ¥æ”¶è¿›ç¨‹Handlerå¼€å§‹æ‰§è¡Œ\nğŸ“¨ æ”¶åˆ°æ¥è‡ªå‘é€è¿›ç¨‹çš„æ¶ˆæ¯: Traceæµ‹è¯•æ¶ˆæ¯\nğŸ”„ å¤„ç†ä¸­...\nğŸ“¤ å‘é€å“åº”æ¶ˆæ¯\nâœ… æ¥æ”¶è¿›ç¨‹Handleræ‰§è¡Œå®Œæˆ",
    "prompt": "[Inbox:4]> "
  }
}
```

### Phase 4: æ ¹å› åˆ†æ

#### Referenceæœºåˆ¶è§£æ

**å…³é”®æ´å¯Ÿ**ï¼šæ¯ä¸ªæ¶ˆæ¯å¤„ç†æ­¥éª¤éƒ½ä¼šè·å¾—æ–°çš„Referenceç¼–å·ï¼

1. **åŸå§‹å‘é€**ï¼ševalå‘é€æ¶ˆæ¯ â†’ `Reference: 8`
2. **ç³»ç»Ÿå¤„ç†**ï¼šAOSè®°å½•ç³»ç»Ÿæ¶ˆæ¯ â†’ `Reference: 8`
3. **ä¸šåŠ¡å¤„ç†**ï¼šHandlerå¤„ç†ä¸šåŠ¡é€»è¾‘ â†’ `Reference: 9`
4. **å“åº”ç”Ÿæˆ**ï¼šHandlerç”Ÿæˆå“åº”æ¶ˆæ¯ â†’ `Reference: 9`

#### TraceåŠŸèƒ½è®¾è®¡ç¼ºé™·

å½“å‰TraceåŠŸèƒ½çš„æŸ¥æ‰¾é€»è¾‘ï¼š
```javascript
// æŸ¥æ‰¾ä¸å‘é€æ¶ˆæ¯ReferenceåŒ¹é…çš„è®°å½•
const hasMatchingReference = edge.node.Messages.some(msg =>
  msg.Tags && msg.Tags.some(tag =>
    tag.name === 'Reference' && tag.value === messageReference
  )
);
```

**é—®é¢˜**ï¼šå®ƒåªæŸ¥æ‰¾ä¸åŸå§‹å‘é€Referenceï¼ˆ8ï¼‰åŒ¹é…çš„è®°å½•ï¼Œä½†çœŸæ­£çš„Handlerè¾“å‡ºè®°å½•åœ¨ä¸åŒçš„Referenceï¼ˆ9ï¼‰ä¸‹ã€‚

## è§£å†³æ–¹æ¡ˆæ¢ç´¢

### Option 1: æ‰©å±•ReferenceåŒ¹é…

ä¿®æ”¹TraceåŠŸèƒ½ï¼Œæ”¯æŒæŸ¥æ‰¾ç›¸å…³æ¶ˆæ¯é“¾ï¼š

```javascript
// æŸ¥æ‰¾ä¸å‘é€Referenceç›¸å…³çš„æ‰€æœ‰æ¶ˆæ¯
const relatedReferences = [messageReference, messageReference + 1, messageReference - 1];
const hasMatchingReference = edge.node.Messages.some(msg => {
  const refTag = msg.Tags?.find(tag => tag.name === 'Reference');
  return refTag && relatedReferences.includes(parseInt(refTag.value));
});
```

### Option 2: åŸºäºæ—¶é—´æˆ³å…³è”

é€šè¿‡æ—¶é—´æˆ³å…³è”ç›¸å…³æ¶ˆæ¯ï¼š
```javascript
// æŸ¥æ‰¾å‘é€æ—¶é—´å‰åä¸€æ®µæ—¶é—´å†…çš„æ‰€æœ‰æ¶ˆæ¯
const timeWindow = 60000; // 1åˆ†é’Ÿ
const messageTime = getMessageTimestamp(evalResult);
const recordTime = getRecordTimestamp(edge.node);

if (Math.abs(recordTime - messageTime) < timeWindow) {
  // å¯èƒ½æ˜¯ç›¸å…³çš„æ¶ˆæ¯
}
```

### Option 3: åŠ¨æ€å†…å®¹åˆ†æ

åŸºäºè¾“å‡ºå†…å®¹çš„åŠ¨æ€ç‰¹å¾è¯†åˆ«Handlerè¾“å‡ºï¼ˆé¿å…ç¡¬ç¼–ç ç‰¹å®šåº”ç”¨å†…å®¹ï¼‰ï¼š

```javascript
const isHandlerOutput = (outputData) => {
  const cleanData = outputData.replace(/\u001b\[[0-9;]*m/g, ''); // æ¸…ç†ANSIä»£ç 

  // æ’é™¤å·²çŸ¥çš„ç³»ç»Ÿè¾“å‡ºæ¨¡å¼
  if (cleanData.includes('function: 0x') &&
      cleanData.includes('Message added to outbox')) {
    return false; // ç³»ç»Ÿè¾“å‡º
  }

  // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸šåŠ¡é€»è¾‘ç‰¹å¾
  const hasBusinessFeatures = cleanData.length > 50 || // å†…å®¹è¾ƒé•¿
                              cleanData.includes('\n') || // å¤šè¡Œè¾“å‡º
                              /[\u{1F600}-\u{1F64F}]/u.test(cleanData) || // åŒ…å«emoji
                              /\p{Script=Han}/u.test(cleanData); // åŒ…å«ä¸­æ–‡

  return hasBusinessFeatures;
};
```

## ç»“è®º

### æ ¸å¿ƒå‘ç°

1. **CU APIæ•°æ®å®Œæ•´æ€§**ï¼šé“¾ä¸Šæ•°æ®ç¡®å®å®Œæ•´è®°å½•äº†æ‰€æœ‰æ¶ˆæ¯å¤„ç†å†å²
2. **Referenceæœºåˆ¶**ï¼šæ¯ä¸ªå¤„ç†æ­¥éª¤è·å¾—ç‹¬ç«‹çš„Referenceç¼–å·
3. **TraceåŠŸèƒ½ç¼ºé™·**ï¼šåªæŸ¥æ‰¾å•ä¸€Referenceï¼Œé”™è¿‡äº†ç›¸å…³çš„ä¸šåŠ¡æ¶ˆæ¯

### æŠ€æœ¯å¯ç¤º

- AOçš„æ¶ˆæ¯å¤„ç†æ˜¯åˆ†æ­¥éª¤çš„ï¼Œæ¯æ­¥éƒ½æœ‰ç‹¬ç«‹çš„çŠ¶æ€è®°å½•
- CU APIè®°å½•äº†å®Œæ•´çš„å¤„ç†é“¾ï¼Œä½†éœ€è¦æ­£ç¡®çš„å…³è”æ–¹å¼
- è·¨è¿›ç¨‹è°ƒè¯•éœ€è¦ç†è§£æ¶ˆæ¯çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ

### æœªæ¥æ”¹è¿›æ–¹å‘

1. **å¢å¼ºTraceç®—æ³•**ï¼šæ”¯æŒå…³è”æ¶ˆæ¯é“¾æŸ¥æ‰¾
2. **CU APIä¼˜åŒ–**ï¼šæä¾›æ›´å¥½çš„æ¶ˆæ¯å…³è”æŸ¥è¯¢æ¥å£
3. **æ–‡æ¡£å®Œå–„**ï¼šè¯¦ç»†è¯´æ˜Referenceæœºåˆ¶å’Œæ¶ˆæ¯å¤„ç†æµç¨‹

---

*æœ¬æ–‡æ¡£åŸºäºå®é™…è°ƒè¯•æ•°æ®ç¼–å†™ï¼Œè®°å½•äº†å®Œæ•´çš„åˆ†æè¿‡ç¨‹å’ŒæŠ€æœ¯å‘ç°ã€‚*
